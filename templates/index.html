<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IoT Monitoring</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
    <main class="layout">
        <section id="alarm-panel" class="alarm hidden">
            <div class="alarm-content">
                <span id="alarm-text">ALARM ACTIVE</span>
                <button id="alarm-off-btn">Isključi alarm</button>
            </div>
        </section>
        <section>
            <h1>Trenutno stanje elemenata sistema</h1>
            <p class="hint">Podaci se osvežavaju svakih 10 sekundi.</p>
            <table>
                <thead>
                    <tr>
                        <th>Senzor</th>
                        <th>Tip</th>
                        <th>Vrednost / Stanje</th>
                        <th>Uređaj</th>
                        <th>PI ID</th>
                        <th>Vreme</th>
                    </tr>
                </thead>
                <tbody id="states-body"></tbody>
            </table>
        </section>

        <section>
            <h2>Grafana vizuelizacija</h2>
            {% if dashboard_uid %}
            <iframe
                src="http://localhost:3000/d/iot-overview/iot-overview?orgId=1&from=now-6h&to=now&timezone=browser&refresh=10s"
                width="100%"
                height="900"
            ></iframe>
            {% else %}
            <div class="empty">Postavite grafana.dashboard_uid u settings.json da biste prikazali ugrađeni panel.</div>
            {% endif %}
        </section>
    </main>

    <script>
        const body = document.getElementById('states-body');

        function renderRows(states) {
            body.innerHTML = '';
            states.forEach((item) => {
                const value = item.value ?? item.state ?? 'N/A';
                const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'N/A';
                const unit = item.unit ? ` ${item.unit}` : '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.sensor}</td>
                    <td>${item.sensor_type}</td>
                    <td>${value}${unit}</td>
                    <td>${item.device}</td>
                    <td>${item.pi_id}</td>
                    <td>${timestamp}</td>
                `;
                body.appendChild(row);
            });
        }

        async function loadStates() {
            try {
                const response = await fetch('/api/states');
                const data = await response.json();
                renderRows(data.states || []);
            } catch (error) {
                console.error('Greška pri učitavanju stanja:', error);
            }
        }

        loadStates();
        setInterval(loadStates, 10000);

        const alarmPanel = document.getElementById("alarm-panel");
        const alarmBtn = document.getElementById("alarm-off-btn");

        alarmBtn.onclick = async () => {
            await fetch("/api/alarm/off", { method: "POST" });
        };

        function updateAlarmUI(state) {
            if (state.active) {
                alarmPanel.classList.remove("hidden");
            } else {
                alarmPanel.classList.add("hidden");
            }
        }

        fetch("/api/alarm")
            .then(r => r.json())
            .then(updateAlarmUI);

        const evt = new EventSource("/api/alarm/stream");
        evt.onmessage = (e) => {
            const state = JSON.parse(e.data);
            updateAlarmUI(state);
        };
    </script>
</body>
</html>
