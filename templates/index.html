<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IoT Monitoring</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
    <main class="layout">
        <section id="alarm-panel" class="alarm hidden">
            <div class="alarm-content">
                <span id="alarm-text">ALARM ISKLJUCEN</span>
                <button id="alarm-off-btn">Isključi alarm</button>
            </div>
        </section>
        <section id="timer-panel" class="timer">
            <div class="timer-content">
                <span id="timer-display">00:00</span>
                <button id="timer-add-btn">+N sekundi</button>
                <input type="number" id="timer-set-input" placeholder="Vreme u s" />
                <button id="timer-set-btn">Postavi</button>
            </div>
        </section>

        <section id="rgb-panel" class="rgb">
            <div class="rgb-content">
                <input type="color" id="rgb-color-picker" value="#ffffff" />
                <button id="rgb-send-btn">Postavi boju</button>
            </div>
        </section>
        <section>
            <h1>Trenutno stanje elemenata sistema</h1>
            <p class="hint">Podaci se osvežavaju svakih 10 sekundi.</p>
            <table>
                <thead>
                    <tr>
                        <th>Senzor</th>
                        <th>Tip</th>
                        <th>Vrednost / Stanje</th>
                        <th>Uređaj</th>
                        <th>PI ID</th>
                        <th>Vreme</th>
                    </tr>
                </thead>
                <tbody id="states-body"></tbody>
            </table>
        </section>

        <section>
            <h2>Grafana vizuelizacija</h2>
            {% if dashboard_uid %}
            <iframe
                src="http://localhost:3000/d/iot-overview/iot-overview?orgId=1&from=now-6h&to=now&timezone=browser&refresh=10s"
                width="100%"
                height="900"
            ></iframe>
            {% else %}
            <div class="empty">Postavite grafana.dashboard_uid u settings.json da biste prikazali ugrađeni panel.</div>
            {% endif %}
        </section>
    </main>

    <script>
        const body = document.getElementById('states-body');

        function renderRows(states) {
            body.innerHTML = '';
            states.forEach((item) => {
                const value = item.value ?? item.state ?? 'N/A';
                const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'N/A';
                const unit = item.unit ? ` ${item.unit}` : '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.sensor}</td>
                    <td>${item.sensor_type}</td>
                    <td>${value}${unit}</td>
                    <td>${item.device}</td>
                    <td>${item.pi_id}</td>
                    <td>${timestamp}</td>
                `;
                body.appendChild(row);
            });
        }

        async function loadStates() {
            try {
                const response = await fetch('/api/states');
                const data = await response.json();
                renderRows(data.states || []);
            } catch (error) {
                console.error('Greška pri učitavanju stanja:', error);
            }
        }

        loadStates();
        setInterval(loadStates, 10000);

        const alarmPanel = document.getElementById("alarm-panel");
        const alarmBtn = document.getElementById("alarm-off-btn");

        alarmBtn.onclick = async () => {
            await fetch("/api/alarm/off", { method: "POST" });
        };

        function updateAlarmUI(state) {
            const alarmText = document.getElementById("alarm-text");
            if (state.active) {
                alarmText.textContent = "ALARM ULJUCEN";

                alarmPanel.classList.remove("hidden");
            } else {
                alarmText.textContent = "ALARM ISKLJUCEN";

                alarmPanel.classList.add("hidden");
            }
        }

        fetch("/api/alarm")
            .then(r => r.json())
            .then(updateAlarmUI);

        const evt = new EventSource("/api/alarm/stream");
        evt.onmessage = (e) => {
            const state = JSON.parse(e.data);
            updateAlarmUI(state);
        };

        // ===== Timer =====
        const timerDisplay = document.getElementById("timer-display");
        const timerAddBtn = document.getElementById("timer-add-btn");
        const timerSetBtn = document.getElementById("timer-set-btn");
        const timerSetInput = document.getElementById("timer-set-input");

        timerAddBtn.onclick = async () => {
            await fetch("/api/timer/add_step", { method: "POST" });
        };

        timerSetBtn.onclick = async () => {
            const seconds = parseInt(timerSetInput.value);
            if (!isNaN(seconds)) {
                await fetch("/api/timer/set", { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ seconds }) 
                });
            }
        };

        function updateTimerUI(state) {
            let mins = Math.floor(state.remaining / 60).toString().padStart(2, '0');
            let secs = (state.remaining % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${mins}:${secs}`;
            timerDisplay.style.visibility = 'visible';
        }

        const timerEvt = new EventSource("/api/timer/stream");
        timerEvt.onmessage = (e) => {
            const state = JSON.parse(e.data);
            updateTimerUI(state);
        };

        const rgbPicker = document.getElementById("rgb-color-picker");
        const rgbSendBtn = document.getElementById("rgb-send-btn");

        rgbSendBtn.onclick = () => {
            fetch("/api/rgb", { 
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ color: rgbPicker.value })
            });
        };

        function updateRGBUI(state) {
            if (state.color) {
                rgbPicker.value = state.color;
            }
        }

        // Live updates
        const rgbEvt = new EventSource("/api/rgb/stream");
        rgbEvt.onmessage = (e) => {
            const state = JSON.parse(e.data);
            updateRGBUI(state);
        };
    </script>
</body>
</html>
